# Multi-Page Export Implementation

## Overview
Implemented professional multi-page PDF and PNG export functionality with headers and footers for simulation results.

## Changes Made

### 1. SimulationResults.vue - Added Section Markers
**File**: `/apps/client/src/features/simulation/components/results/layouts/SimulationResults.vue`

Added `data-export-section` and `data-export-page` attributes to organize content into logical pages:

```vue
<!-- Page 1: Inputs and Key Metrics -->
<section data-export-section="inputs-metrics" data-export-page="1">
  <SimulationInputs />
  <KeyMetrics />
</section>

<!-- Page 1: Policy and Weights -->
<div data-export-section="policy-weights" data-export-page="1">
  <PolicyRangeAndWeights />
</div>

<!-- Page 2: Charts -->
<div data-export-section="charts" data-export-page="2">
  <EndowmentValueChart />
  <SpendingPolicyAmount />
</div>

<!-- Page 3: Statistical Summary and Data Table -->
<div data-export-section="statistics" data-export-page="3">
  <StatisticalSummarySection />
  <SimulationDataByPercentile />
</div>

<!-- Page 4: Risk Analysis -->
<div data-export-section="risk" data-export-page="4">
  <TailRisk />
</div>

<!-- Page 5: Methodology -->
<div data-export-section="methodology" data-export-page="5">
  <MethodologyNotes />
</div>
```

### 2. useExport.ts - Multi-Page Export Logic
**File**: `/apps/client/src/features/simulation/composables/useExport.ts`

#### New Functions Added:

**`exportMultiPagePNG()`**
- Exports each section as a separate PNG file
- Naming: `filename-page-1.png`, `filename-page-2.png`, etc.
- 100ms delay between downloads to prevent browser blocking

**`exportMultiPagePDF()`**
- Creates single PDF with multiple pages
- Each page includes:
  - **Header**: "Endowcast Simulation Results" + Date
  - **Content**: Section canvas/image
  - **Footer**: "Page X of Y" + "Generated by Endowcast"
- Handles oversized sections by splitting across multiple pages
- Professional styling with subtle gray headers/footers

**`exportSinglePage()`**
- Fallback for backward compatibility
- Used when no `data-export-section` markers found
- Maintains original single-page export behavior

#### Page Layout Specifications:
```typescript
const pageWidth = 210;      // A4 width in mm
const pageHeight = 297;     // A4 height in mm
const margin = 10;          // mm
const headerHeight = 15;    // mm
const footerHeight = 10;    // mm
const contentHeight = 163;  // mm (calculated)
```

#### Header Content:
- **Left**: "Endowcast Simulation Results"
- **Right**: Current date (formatted: "Nov 20, 2025")
- **Styling**: 9pt gray text, subtle divider line

#### Footer Content:
- **Left**: "Page X of Y"
- **Right**: "Generated by Endowcast"
- **Styling**: 8pt gray text

### 3. Export Flow

**PDF Export:**
1. Find all `[data-export-section]` elements
2. Capture each section individually with html2canvas
3. For each section:
   - Add new PDF page (except first)
   - Render header with title and date
   - Add section image to content area
   - If section too tall → split across multiple pages
   - Render footer with page numbers
4. Save single PDF file

**PNG Export:**
1. Find all `[data-export-section]` elements
2. Capture each section individually
3. Save each as separate PNG file:
   - `endowcast-results-2025-11-20-page-1.png`
   - `endowcast-results-2025-11-20-page-2.png`
   - etc.

## Page Organization

### Page 1: Overview
- Simulation inputs summary
- Key performance metrics
- Portfolio allocation and policy ranges

### Page 2: Visual Analysis
- Endowment value chart (with percentile bands)
- Spending policy amount chart

### Page 3: Statistical Data
- Statistical summary table
- Simulation data by percentile table

### Page 4: Risk Metrics
- Tail risk analysis
- Loss probability scenarios
- Safe spending calculations

### Page 5: Documentation
- Methodology notes
- Assumptions and disclaimers

## Benefits

✅ **Professional Appearance**
- Clean headers and footers on every page
- Consistent page numbering
- Branded with "Endowcast" identity

✅ **Better Page Breaks**
- Sections don't get awkwardly cut mid-content
- Charts remain intact and readable
- Tables aren't split mid-row

✅ **Printable**
- Each page fits standard A4/Letter paper
- Margins suitable for binding
- Headers/footers visible when printed

✅ **Flexible Output**
- PDF: Single multi-page file (easy to share)
- PNG: Separate files per page (easy to embed in presentations)

✅ **Backward Compatible**
- Falls back to single-page export if sections not found
- Existing functionality preserved

## Technical Details

### Image Compression
- **JPEG quality**: 92% for good balance of quality/size
- **PNG quality**: 95% for lossless compression
- **Compression mode**: 'FAST' for quicker generation

### Progress Tracking
- Separate progress bars for PNG vs PDF
- Granular updates during section capture
- User sees real-time export status

### Error Handling
- Continues export even if one section fails
- Console warnings for failed sections
- Graceful degradation to single-page mode

### Performance
- Sections captured in sequence (not parallel) to avoid memory issues
- Small delays between PNG downloads prevent browser blocking
- Stable layout detection ensures charts fully render

## Usage

No changes needed in client code. Export functions automatically:

```typescript
// PDF export (multi-page with headers/footers)
await exportElement(element, { 
  format: 'pdf', 
  filename: 'my-results' 
});

// PNG export (separate files per page)
await exportElement(element, { 
  format: 'png', 
  filename: 'my-results' 
});
```

## Future Enhancements

Potential improvements:
- [ ] Custom header/footer text via options
- [ ] Logo/branding in header
- [ ] Table of contents on first page
- [ ] Scenario name in header
- [ ] PDF bookmarks for sections
- [ ] Option to combine PNGs into single image with dividers

## Build Status
✅ Client build successful (4.15s)  
✅ No TypeScript errors  
✅ Bundle size: ResultsView increased from 105KB → 108KB (+3KB for multi-page logic)
